const API_BASE = '/api'; class GratitudeTree { constructor() { this.leaves = []; this.uniqueStudents = new Set(); this.uniqueTeachers = new Set(); this.isOnline = false; this.init(); } async init() { await this.checkDatabaseConnection(); await this.loadLeaves(); } async checkDatabaseConnection() { try { const response = await fetch(`${API_BASE}/get-leaves`); const result = await response.json(); this.isOnline = result.success; this.updateDatabaseStatus(); console.log(this.isOnline ? 'âœ… Connected to Neon database' : 'âŒ Database offline'); } catch (error) { console.log('âŒ Network error, using localStorage'); this.isOnline = false; this.updateDatabaseStatus(); } } async loadLeaves() { if (this.isOnline) { await this.loadFromDatabase(); } else { this.loadFromLocalStorage(); } this.updateStats(); this.renderLeaves(); } async loadFromDatabase() { try { const response = await fetch(`${API_BASE}/get-leaves`); const result = await response.json(); if (result.success) { this.leaves = result.data; this.updateUniqueSets(); this.saveToLocalStorage(); console.log(`âœ… Loaded ${this.leaves.length} leaves from database`); } } catch (error) { console.error('Failed to load from database:', error); this.loadFromLocalStorage(); } } loadFromLocalStorage() { const saved = localStorage.getItem('gratitudeLeaves'); if (saved) { this.leaves = JSON.parse(saved); this.updateUniqueSets(); console.log(`ðŸ“¦ Loaded ${this.leaves.length} leaves from localStorage`); } } async addLeaf(name, teacher, message) { const newLeafData = { name: name, teacher: teacher, message: message, x: Math.floor(Math.random() * 450 + 75), y: Math.floor(Math.random() * 550 + 100), type: this.getRandomLeafType(), gradient: this.getRandomGradient() }; if (this.isOnline) { return await this.addLeafToDatabase(newLeafData); } else { return this.addLeafToLocalStorage(newLeafData); } } async addLeafToDatabase(leafData) { try { const response = await fetch(`${API_BASE}/add-leaf`, { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(leafData) }); const result = await response.json(); if (result.success) { const savedLeaf = result.data; this.leaves.unshift(savedLeaf); this.updateUniqueSets(); this.saveToLocalStorage(); this.updateStats(); this.renderLeaves(); return savedLeaf; } else { throw new Error(result.error); } } catch (error) { console.error('Failed to save to database:', error); return this.addLeafToLocalStorage(leafData); } } addLeafToLocalStorage(leafData) { const newLeaf = { ...leafData, id: Date.now(), created_at: new Date().toISOString() }; this.leaves.unshift(newLeaf); this.updateUniqueSets(); this.saveToLocalStorage(); this.updateStats(); this.renderLeaves(); return newLeaf; } updateUniqueSets() { this.uniqueStudents.clear(); this.uniqueTeachers.clear(); this.leaves.forEach(leaf => { this.uniqueStudents.add(leaf.name); this.uniqueTeachers.add(leaf.teacher); }); } saveToLocalStorage() { localStorage.setItem('gratitudeLeaves', JSON.stringify(this.leaves)); } getRandomLeafType() { const types = ['heart', 'maple', 'willow', 'clover']; return types[Math.floor(Math.random() * types.length)]; } getRandomGradient() { const gradients = ['gradient-1', 'gradient-2', 'gradient-3', 'gradient-4']; return gradients[Math.floor(Math.random() * gradients.length)]; } updateStats() { document.getElementById('leaf-count').textContent = this.leaves.length; document.getElementById('student-count').textContent = this.uniqueStudents.size; document.getElementById('teacher-count').textContent = this.uniqueTeachers.size; } updateDatabaseStatus() { const statusElement = document.getElementById('db-status'); if (statusElement) { if (this.isOnline) { statusElement.innerHTML = 'ðŸŸ¢ ÄÃ£ káº¿t ná»‘i Neon Database'; statusElement.style.color = '#2e7d32'; } else { statusElement.innerHTML = 'ðŸŸ¡ Äang dÃ¹ng localStorage (offline)'; statusElement.style.color = '#ff9800'; } } } renderLeaves() { const container = document.getElementById('leaves-container'); if (!container) return; container.innerHTML = ''; this.leaves.forEach((leaf, index) => { const leafElement = this.createLeafElement(leaf, index); container.appendChild(leafElement); }); } createLeafElement(leaf, index) { const leafElement = document.createElement('div'); leafElement.className = `leaf ${leaf.type} ${leaf.gradient}`; leafElement.setAttribute('data-leaf-id', leaf.id); leafElement.style.left = leaf.x + 'px'; leafElement.style.top = leaf.y + 'px'; leafElement.style.animationDelay = (index * 0.1) + 's'; const randomRotate = Math.random() * 360; leafElement.style.transform = `rotate(${randomRotate}deg)`; leafElement.innerHTML = `
${leaf.name}
â†’ ${leaf.teacher}
`; leafElement.onclick = () => this.showLeafDetail(leaf); return leafElement; } showLeafDetail(leaf) { const time = new Date(leaf.created_at).toLocaleDateString('vi-VN', { year: 'numeric', month: 'long', day: 'numeric', hour: '2-digit', minute: '2-digit' }); const message = `ðŸ’Œ Lá»i tri Ã¢n:\n"${leaf.message}"\n\nðŸ‘¤ ${leaf.name}\nðŸŽ“ Gá»­i ${leaf.teacher}\nðŸ“… ${time}`; showSuccessMessage(message, false, 8000); } getLeafById(id) { return this.leaves.find(leaf => leaf.id === id); } } const gratitudeTree = new GratitudeTree(); function showSuccessMessage(message, isError = false, duration = 4000) { const oldMsg = document.querySelector('.success-message'); if (oldMsg) oldMsg.remove(); const successMsg = document.createElement('div'); successMsg.className = 'success-message'; successMsg.innerHTML = message.replace(/\n/g, '
'); const closeBtn = document.createElement('button'); closeBtn.textContent = 'âœ•'; closeBtn.style.cssText = ` position: absolute; top: 10px; right: 15px; background: none; border: none; color: white; font-size: 20px; cursor: pointer; `; closeBtn.onclick = () => successMsg.remove(); successMsg.appendChild(closeBtn); document.body.appendChild(successMsg); setTimeout(() => { if (successMsg.parentNode) successMsg.remove(); }, duration); } document.addEventListener('DOMContentLoaded', function() { const modal = document.getElementById('formModal'); document.getElementById('addLeafButton')?.addEventListener('click', () => { modal.style.display = 'block'; }); document.getElementById('closeModal')?.addEventListener('click', () => { modal.style.display = 'none'; }); document.getElementById('gratitudeForm')?.addEventListener('submit', async (e) => { e.preventDefault(); const name = document.getElementById('studentName').value.trim(); const teacher = document.getElementById('teacherName').value.trim(); const message = document.getElementById('message').value.trim(); if (name && teacher && message) { await gratitudeTree.addLeaf(name, teacher, message); modal.style.display = 'none'; e.target.reset(); const count = gratitudeTree.leaves.length; if (count === 1) { showSuccessMessage('ðŸŽ‰ Báº¡n Ä‘Ã£ thÃªm chiáº¿c lÃ¡ Ä‘áº§u tiÃªn!\n\nCáº£m Æ¡n báº¡n Ä‘Ã£ khá»Ÿi Ä‘áº§u cÃ¢y tri Ã¢n! ðŸ’š', false, 5000); } else { showSuccessMessage(`ðŸŽ‰ LÃ¡ tri Ã¢n Ä‘Ã£ Ä‘Æ°á»£c thÃªm!\n\nCÃ¢y Ä‘ang cÃ³ ${count} lÃ¡ tri Ã¢n. ðŸ’š`, false, 4000); } } }); window.addEventListener('click', (e) => { if (e.target === modal) modal.style.display = 'none'; }); });
